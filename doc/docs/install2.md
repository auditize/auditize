# Installation

Auditize is a Python 3.12+ application that uses MongoDB as a database and do not use the filesystem to persist data. It's base configuration is 100% environment variables based, making it easy and flexible to configure Auditize, especially in a Docker environment.

Auditize is composed of two distinct services:

- an [ASGI](https://en.wikipedia.org/wiki/Asynchronous_Server_Gateway_Interface) web application that serves both the API and the frontend
- a scheduler that runs period tasks

It is delivered as a [Python package on PyPI](https://pypi.org/project/auditize/) that can be installed with `pip`.

The following sections will guide you through the installation of Auditize in two different contexts:

- a Docker Compose environment
- a standalone environment

## Docker Compose

The Docker Compose environment described here provides a complete Auditize setup including MongoDB.

First, create an `auditize-docker` directory where you will store the various files related to your Auditize's Docker setup, and go to this directory:

```bash
mkdir auditize-docker
cd auditize-docker
```

Then, create a `Dockerfile` file with the following content:

```Dockerfile
FROM python:3.12

RUN pip install auditize

EXPOSE 80

ENTRYPOINT ["auditize"]
```

!!! warning

    This is a minimal Dockerfile that installs the `auditize` package and exposes the port 80. In a real-world / production setup, you would typically implement security and optimization measures such as:
    
    - running the application as a non-root user,
    - using a non-privileged port,
    - making the Docker image as small as possible by using an optimized base image,
    - pin the version of the `auditize` package to a specific version,
    - etc.

This image will be used to run both the web application and the scheduler Docker Compose services.

Now, build a Docker image from this Dockerfile:

```bash
docker build -t auditize .
```

Next, create a `docker-compose.yml` file in the same directory with the following content:
  
```yaml
services:
  mongo:
    image: mongo
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: root
    volumes:
      - mongo-data:/data/db
  web:
    image: auditize
    depends_on:
      - mongo
    command: ["serve", "--host", "0.0.0.0", "--port", "80"]
    ports:
      - "8000:80"
    env_file: ".env"
    environment:
      - AUDITIZE_MONGODB_URI=mongodb://root:root@mongo:27017/
  scheduler:
    image: auditize
    depends_on:
      - mongo
    command: ["schedule"]
    env_file: ".env"
    environment:
      - AUDITIZE_MONGODB_URI=mongodb://root:root@mongo:27017/
      # we set PYTHONUNBUFFERED, otherwise the print() from "schedule" are not shown
      - PYTHONUNBUFFERED=1
volumes:
  mongo-data:
```

This `docker-compose.yml` uses a `.env` file for the Auditize base-configuration, so let's create a `.env` file in the same directory with at least the following configuration elements:

```bash
AUDITIZE_BASE_URL=http://localhost:8000
AUDITIZE_JWT_SIGNING_KEY=YOUR_AUDITIZE_JWT_SIGNING_KEY
```

- `AUDITIZE_BASE_URL` is the public URL of your Auditize instance from which the web application is accessed by users or API clients (e.g. `https://auditize.example.com`). It is used to generate URLs in the emails sent by Auditize.
- `AUDITIZE_JWT_SIGNING_KEY` is the key used to sign the JWT tokens generated by Auditize (e.g. user sessions).

Please refer to the [configuration documentation](config.md) for more details.

Finally, start the Docker containers:

```bash
docker compose up -d
```

Before you can use Auditize, you need to create a superadmin user. You can do this by running the following command:

```bash
docker exec -it auditize-docker-web-1 auditize bootstrap-superadmin YOUR_EMAIL YOUR_FIRST_NAME YOUR_LAST_NAME 
```

Where:

- `auditize-docker-web-1` is the name of the web container to run the command from
- `YOUR_EMAIL`, `YOUR_FIRST_NAME`, and `YOUR_LAST_NAME` must be replaced by your actual user information

The command will prompt you for a password and then create the superadmin user.

You can now access Auditize at `http://localhost:8000`.

### Using Gunicorn

The previous setup uses `auditize serve` to run the web application. What this command does is to run the [Uvicorn](https://www.uvicorn.org/) ASGI server with one worker. You may want to use [Gunicorn](https://gunicorn.org/) with multiple workers for better performance as recommended in the [Uvicorn documentation](https://www.uvicorn.org/#running-with-gunicorn).

In this case, you can follow the same steps as above but make the following change in `Dockerfile`:

```Dockerfile
# RUN pip install auditize
RUN pip install auditize gunicorn
```

And this change in the `docker-compose.yml` file:

```yaml
# command: ["serve", "--host", "0.0.0.0", "--port", "80"]
entrypoint:
  [
    "gunicorn",
    "auditize:asgi()",
    "-k",
    "uvicorn.workers.UvicornWorker",
    "-w",
    "4",
    "-b",
    "0.0.0.0:80",
  ]
```

In this example, Gunicorn is configured to run 4 workers with the Uvicorn worker class. You can adjust the number of workers according to your needs.

!!! note

    Since Auditize is an ASGI application, you can use any other ASGI server instead of Uvicorn or Uvicorn+Gunicorn. 

### Ngnix, TLS, Kubernetes and beyond

The Docker Compose environment described here is a good starting point to run Auditize in a development/test environment. For a production deployment, you should consider:

- using a reverse proxy such as Nginx to serve the web application and handle TLS termination,
- deploying Auditize in a Kubernetes cluster with a proper ingress controller,
- build a custom Docker image with security and optimization measures,
- etc.

When deploying Auditize in a Kubernetes cluster, you have the flexibility to scale it by choosing between multiple pods running directly with Uvicorn and a single worker (through `auditize serve`) or using Gunicorn with multiple workers. Using Uvicorn directly in each pod can be simpler and more lightweight, making it easier to manage and scale horizontally. The FastAPI documentation provides [more information](https://fastapi.tiangolo.com/deployment/docker/) on how to deploy a FastAPI application in Kubernetes.


## Standalone

### Introduction

Auditize supports **Python 3.12+**. This version of Python is available on Ubuntu 24.04+ and RHEL 9.4+ (among others) as time of writing.

In this section, we will build a standalone Auditize environment using:
- Auditize installed in a Python virtual environment
- Gunicorn with ASGI workers
- Nginx as a reverse proxy

We assume that a working MongoDB instance is available and that you have a MongoDB URI to connect to it.

Here, we take Ubuntu 24.04 as an example, but the steps should be similar for other Linux distributions (especially Debian-based ones and distros using `systemd`).

### Install and configure Auditize

First, install the `virtualenv` package and create a Python virtual environment with Auditize and Gunicorn:
```bash

sudo apt install python3-virtualenv
sudo virtualenv /opt/auditize
sudo /opt/auditize/bin/pip install auditize gunicorn
```

Create a `/opt/auditize/env` file containing your [Auditize configuration](config.md). It should contain at least the required fields `AUDITIZE_BASE_URL`, `AUDITIZE_JWT_SIGNING_KEY`, and `AUDITIZE_MONGODB_URI` if your MongoDB server is not running locally:
```bash
AUDITIZE_BASE_URL=...
AUDITIZE_JWT_SIGNING_KEY=...
AUDITIZE_MONGODB_URI=...
```

Then, ensure appropriate permissions and ownership on this file:
```bash
sudo chown www-data:www-data /opt/auditize/env
sudo chmod 660 /opt/auditize/env
```

Bootstrap the superadmin user:

```bash
sudo AUDITIZE_CONFIG=/opt/auditize/env /opt/auditize/bin/auditize bootstrap-superadmin YOUR_EMAIL YOUR_FIRST_NAME YOUR_LAST_NAME
```

The `auditize bootstrap-superadmin` command will prompt you for a password and then create the superadmin user.

### Run Gunicorn through systemd

We are going to use `systemd` to create a UNIX socket for Gunicorn. Nginx will forward requests to this socket and `systemd` will start the Gunicorn service when needed.

Create a `/etc/systemd/system/auditize-gunicorn.socket` file with this content:

```ini
[Unit]
Description=Unix socket for Auditize Gunicorn

[Socket]
ListenStream=/run/gunicorn.sock
SocketUser=www-data
SocketGroup=www-data
SocketMode=0660

[Install]
WantedBy=sockets.target
```

Create a `/etc/systemd/system/auditize-gunicorn.service`:

```ini
[Unit]
Description=Run Auditize using Gunicorn
Requires=auditize-gunicorn.socket
After=network.target

[Service]
Type=notify
NotifyAccess=main
User=www-data
Group=www-data
WorkingDirectory=/opt/auditize
EnvironmentFile=/opt/auditize/env
ExecStart=/opt/auditize/bin/gunicorn 'auditize:asgi()' -k uvicorn.workers.UvicornWorker -w 4 # (1)!
ExecReload=/bin/kill -s HUP $MAINPID
KillMode=mixed
TimeoutStopSec=5
PrivateTmp=true

[Install]
WantedBy=multi-user.target
```

1. The `-w 4` option tells Gunicorn to run 4 workers. You can adjust this number according to your needs / host resources.

Enable and start the `auditize-gunicorn.socket` (`systemd` will start the `auditize-gunicorn.service` when needed): :

```bash
sudo systemctl enable auditize-gunicorn.socket
```

### Setup Nginx

Install Nginx:

```bash
sudo apt install nginx
```

Add this Nginx configuration file at `/etc/nginx/sites-available/auditize`:

```nginx
server {
  listen 80;

  location / {
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_redirect off;
    proxy_buffering off;
    proxy_pass http://gunicorn;
  }
}

upstream gunicorn {
  server unix:/run/gunicorn.sock;
}
```

Remove the default Nginx configuration if any:

```bash
sudo rm /etc/nginx/sites-enabled/default
```

Enable the Auditize configuration for Nginx:

```bash
sudo ln -s /etc/nginx/sites-available/auditize /etc/nginx/sites-enabled/auditize
```

Restart Nginx:

```bash
sudo systemctl restart nginx
```